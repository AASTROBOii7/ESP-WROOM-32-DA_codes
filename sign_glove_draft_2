#include <Adafruit_MPU6050.h>
#include <Adafruit_Sensor.h>
#include <Wire.h>
#include "BluetoothSerial.h"

BluetoothSerial SerialBT;
Adafruit_MPU6050 mpu;

// GPIO Pins for ESP32
const int thumbPin  = 33;
const int indexPin  = 32;
const int middlePin = 35;
const int ringPin   = 34;
const int pinkyPin  = 39; // SN (Sensor_VN)

void setup() {
  Serial.begin(115200);
  
  // Initialize Bluetooth
  SerialBT.begin("SignLanguageGlove"); 

  // Initialize MPU6050
  if (!mpu.begin()) {
    Serial.println("Failed to find MPU6050 chip. Check wiring!");
    while (1) { delay(10); }
  }
  
  mpu.setAccelerometerRange(MPU6050_RANGE_8_G);
  mpu.setGyroRange(MPU6050_RANGE_500_DEG);
  mpu.setFilterBandwidth(MPU6050_BAND_21_HZ); 

  Serial.println("Glove & MPU6050 Ready! Pair with 'SignLanguageGlove'");
}

void loop() {
  sensors_event_t a, g, temp;
  mpu.getEvent(&a, &g, &temp);

  // Read Flex Sensors
  int thumb  = map(analogRead(thumbPin), 400, 3000, 0, 100); 
  int index  = map(analogRead(indexPin), 2000, 3500, 0, 100);
  int middle = map(analogRead(middlePin), 2000, 3500, 0, 100);
  int ring   = map(analogRead(ringPin), 2200, 3600, 0, 100);
  int pinky  = map(analogRead(pinkyPin), 1800, 3200, 0, 100);

  // Constrain to 0-100
  thumb = constrain(thumb, 0, 100);
  index = constrain(index, 0, 100);
  middle = constrain(middle, 0, 100);
  ring = constrain(ring, 0, 100);
  pinky = constrain(pinky, 0, 100);

  // Threshold logic
  bool fT = (thumb > 45); 
  bool fI = (index > 60);
  bool fM = (middle > 65);
  bool fR = (ring > 65);
  bool fP = (pinky > 55);

  // MPU6050 Orientation logic
  bool palmForward = (a.acceleration.x > -2.0 && a.acceleration.x < 2.0); 

  String gesture = "";

  // GESTURE RECOGNITION
  if (fT && fI && fM && fR && fP) {
    gesture = "CLEAR";
    SerialBT.print("\033[2J"); 
  }
  else if (!fT && !fI && fM && fR && !fP && palmForward) {
    gesture = "I LOVE YOU";
  }
  else if (!fT && !fI && fM && fR && fP && a.acceleration.x > 7.0) {
    gesture = "G";
  }
  else if (fI && fM && fR && fP && !fT) {
    gesture = "A";
  }
  else if (!fI && !fM && !fR && !fP && fT) {
    gesture = "B";
  }

  // Final Output
  if (gesture != "") {
    Serial.println("Detecting: " + gesture);
    if (gesture != "CLEAR") {
      SerialBT.println(gesture);
    }
  }

  delay(700); 
} // This is the bracket that fixes your error!
