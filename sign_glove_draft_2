#include <Adafruit_MPU6050.h>
#include <Adafruit_Sensor.h>
#include <Wire.h>
#include "BluetoothSerial.h"

BluetoothSerial SerialBT;
Adafruit_MPU6050 mpu;

// Pins
const int thumbPin = 33, indexPin = 32, middlePin = 35, ringPin = 34, pinkyPin = 39;

void setup() {
  Serial.begin(115200);
  SerialBT.begin("SignLanguageGlove");

  // Initialize MPU6050
  if (!mpu.begin()) {
    Serial.println("Failed to find MPU6050 chip");
    while (1) { delay(10); }
  }
  
  mpu.setAccelerometerRange(MPU6050_RANGE_8_G);
  mpu.setGyroRange(MPU6050_RANGE_500_DEG);
  mpu.setFilterBandwidth(MPU6050_FILTER_21_HZ);

  Serial.println("Glove & MPU6050 Ready!");
}

void loop() {
  sensors_event_t a, g, temp;
  mpu.getEvent(&a, &g, &temp);

  // Flex Sensor Readings & Mapping
  int thumb  = map(analogRead(thumbPin), 400, 3000, 0, 100); 
  int index  = map(analogRead(indexPin), 2000, 3500, 0, 100);
  int middle = map(middlePin, 2000, 3500, 0, 100);
  int ring   = map(ringPin, 2200, 3600, 0, 100);
  int pinky  = map(pinkyPin, 1800, 3200, 0, 100);

  bool fT = (thumb > 45), fI = (index > 60), fM = (middle > 65), fR = (ring > 65), fP = (pinky > 55);

  // Orientation Logic (a.x is tilt side-to-side, a.y is tilt forward-back)
  bool palmForward = (a.x > -2.0 && a.x < 2.0); // Hand is vertical
  bool palmDown    = (a.z > 8.0);               // Hand is flat/horizontal

  String gesture = "";

  // GESTURE LOGIC WITH ORIENTATION
  
  // 1. I Love You (Only if palm is forward)
  if (!fT && !fI && fM && fR && !fP && palmForward) {
    gesture = "I LOVE YOU";
  }
  // 2. Letter "G" (Index/Thumb out, but hand must be SIDEWAYS)
  else if (!fT && !fI && fM && fR && fP && a.x > 7.0) {
    gesture = "G";
  }
  // 3. Clear Screen (Fist held for a moment)
  else if (fT && fI && fM && fR && fP) {
    gesture = "CLEAR";
    SerialBT.print("\033[2J");
  }
  // 4. Letter B
  else if (!fI && !fM && !fR && !fP && fT) {
    gesture = "B";
  }

  // Final Output
  if (gesture != "") {
    Serial.println(gesture);
    if (gesture != "CLEAR") SerialBT.println(gesture);
  }

  delay(600);
}
